app-id: io.github.mlm_games.mages
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21
  - org.freedesktop.Sdk.Extension.rust-stable
command: mages

finish-args:
  - --share=ipc
  - --share=network
  - --socket=fallback-x11 # Test, Portals and PipeWire might need this 
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=xdg-run/pipewire-0 # Test if needed for JCEF to be able to talk to the PipeWire daemon
  - --system-talk-name=org.freedesktop.portal.Desktop # test for screen capture
  - --filesystem=xdg-download
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets

build-options:
  env:
    JAVA_HOME: /usr/lib/sdk/openjdk21
    PATH: /usr/lib/sdk/openjdk21/bin:/usr/lib/sdk/rust-stable/bin:/app/bin:/usr/bin
    CARGO_HOME: /run/build/mages/cargo
    CARGO_NET_OFFLINE: 'true'
    GRADLE_USER_HOME: /run/build/mages/gradle-deps
    RUST_BACKTRACE: '1'

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk21/install.sh

  - name: mages
    buildsystem: simple
    sources:
      - type: archive
        url: https://github.com/mlm-games/mages/releases/download/2.4.3/mages-2.4.3-vendored-sources.tar.gz
        sha256: 57f95652abc8c004a434b1f84e9a01400824bdf136b1b766f28d2ea3a3697224
        strip-components: 1

    build-commands:
      # Setup Cargo to use vendored sources
      - |
        mkdir -p cargo
        cp -r .cargo/* cargo/ 2>/dev/null || true
        cat cargo/config.toml

      # Build uniffi-bindgen
      - |
        cd rust/uniffi-bindgen
        cargo build --release --offline

      # Build Rust library
      - |
        cd rust
        cargo build --release --offline

      # Generate Kotlin bindings
      - |
        cd rust
        ./uniffi-bindgen/target/release/uniffi-bindgen generate \
          --library target/release/libmages_ffi.so \
          --language kotlin \
          --out-dir ../shared/src/commonMain/kotlin/

      # Copy native library for JNA
      - |
        mkdir -p shared/src/jvmMain/resources/linux-x86-64
        mkdir -p shared/src/jvmMain/resources/linux-aarch64
        cp rust/target/release/libmages_ffi.so shared/src/jvmMain/resources/linux-x86-64/
        cp rust/target/release/libmages_ffi.so shared/src/jvmMain/resources/linux-aarch64/

      # Build desktop app with Gradle (offline)
      - |
        ./gradlew :desktopApp:createDistributable --offline --no-daemon

      # Install to /app
      - |
        mkdir -p /app/lib/mages
        cp -r desktopApp/build/compose/binaries/main/app/Mages/* /app/lib/mages/

      # Create launcher script
      - |
        mkdir -p /app/bin
        cat > /app/bin/mages << 'EOF'
        #!/bin/bash
        export PATH=/app/lib/mages/lib/runtime/bin:$PATH
        exec /app/lib/mages/bin/Mages "$@"
        EOF
        chmod +x /app/bin/mages

      # Install metadata
      - install -Dm644 fastlane/metadata/android/en-US/images/icon.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm644 packaging/${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 packaging/${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
